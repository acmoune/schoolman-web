{"ast":null,"code":"import _Object$defineProperty from \"@babel/runtime-corejs2/core-js/object/define-property\";\nimport _Object$defineProperties from \"@babel/runtime-corejs2/core-js/object/define-properties\";\nimport _Object$getOwnPropertyDescriptors from \"@babel/runtime-corejs2/core-js/object/get-own-property-descriptors\";\nimport _Object$getOwnPropertyDescriptor from \"@babel/runtime-corejs2/core-js/object/get-own-property-descriptor\";\nimport _Object$getOwnPropertySymbols from \"@babel/runtime-corejs2/core-js/object/get-own-property-symbols\";\nimport _Object$keys from \"@babel/runtime-corejs2/core-js/object/keys\";\nimport _regeneratorRuntime from \"@babel/runtime-corejs2/regenerator\";\nimport _defineProperty from \"@babel/runtime-corejs2/helpers/esm/defineProperty\";\nimport _asyncToGenerator from \"@babel/runtime-corejs2/helpers/esm/asyncToGenerator\";\nimport _objectWithoutProperties from \"@babel/runtime-corejs2/helpers/esm/objectWithoutProperties\";\nimport _taggedTemplateLiteral from \"@babel/runtime-corejs2/helpers/esm/taggedTemplateLiteral\";\nvar __jsx = React.createElement;\n\nfunction ownKeys(object, enumerableOnly) { var keys = _Object$keys(object); if (_Object$getOwnPropertySymbols) { var symbols = _Object$getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return _Object$getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }\n\nfunction _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(source, true).forEach(function (key) { _defineProperty(target, key, source[key]); }); } else if (_Object$getOwnPropertyDescriptors) { _Object$defineProperties(target, _Object$getOwnPropertyDescriptors(source)); } else { ownKeys(source).forEach(function (key) { _Object$defineProperty(target, key, _Object$getOwnPropertyDescriptor(source, key)); }); } } return target; }\n\nfunction _templateObject() {\n  var data = _taggedTemplateLiteral([\"\\n  query getProfile($email: String!) {\\n    account(email: $email) {\\n      id\\n      email\\n      fullName\\n      profile {\\n        id birthDate birthPlace residence phoneNumber nationality\\n        nicNumber nicDateOfIssue nicPlaceOfIssue\\n        highestAcademicQualification yearOfIssue englishGradeInGCEOL mathematicsGradeInGCEOL\\n        professionalQualification employmentStatus jobTitle yearsOfExperience employerName employerAddress\\n        otherDetails\\n      }\\n    }\\n  }\\n\"]);\n\n  _templateObject = function _templateObject() {\n    return data;\n  };\n\n  return data;\n}\n\nimport React from 'react';\nimport { AuthProvider } from '../components/AuthContext';\nimport jwtDecode from 'jwt-decode';\nimport { gql } from 'apollo-boost';\nimport axios from 'axios';\nimport { getCookieFromBrowser, getCookieFromServer } from '../lib/cookie';\nimport { authCookieName, apiBaseUrl } from '../app.config';\nimport Router from 'next/router';\nvar GET_PROFILE_QUERY = gql(_templateObject());\nexport default function withAuth(PageComponent) {\n  var getToken = function getToken(req) {\n    return false ? getCookieFromServer(authCookieName, req) : getCookieFromBrowser(authCookieName);\n  };\n\n  var WithAuth = function WithAuth(_ref) {\n    var currentUser = _ref.currentUser,\n        pageProps = _objectWithoutProperties(_ref, [\"currentUser\"]);\n\n    return __jsx(AuthProvider, {\n      currentUser: currentUser\n    }, __jsx(PageComponent, pageProps));\n  };\n\n  WithAuth.getInitialProps =\n  /*#__PURE__*/\n  function () {\n    var _ref2 = _asyncToGenerator(\n    /*#__PURE__*/\n    _regeneratorRuntime.mark(function _callee(ctx) {\n      var token, currentUser, isValid, _ref3, account, pageProps, _pageProps, authRequired;\n\n      return _regeneratorRuntime.wrap(function _callee$(_context) {\n        while (1) {\n          switch (_context.prev = _context.next) {\n            case 0:\n              token = getToken(ctx.req);\n              currentUser = undefined;\n\n              if (!token) {\n                _context.next = 18;\n                break;\n              }\n\n              isValid = false;\n              _context.prev = 4;\n              _context.next = 7;\n              return axios.post(\"\".concat(apiBaseUrl, \"/validateToken\"), {\n                token: token\n              }, {\n                headers: {\n                  'Content-Type': 'application/json'\n                }\n              });\n\n            case 7:\n              isValid = true;\n              _context.next = 12;\n              break;\n\n            case 10:\n              _context.prev = 10;\n              _context.t0 = _context[\"catch\"](4);\n\n            case 12:\n              if (!isValid) {\n                _context.next = 18;\n                break;\n              }\n\n              _context.next = 15;\n              return ctx.apolloClient.query({\n                query: GET_PROFILE_QUERY,\n                variables: {\n                  email: jwtDecode(token).ema\n                },\n                context: {\n                  headers: {\n                    'schoolman_token': token\n                  }\n                }\n              });\n\n            case 15:\n              _ref3 = _context.sent;\n              account = _ref3.data.account;\n              currentUser = account;\n\n            case 18:\n              // add token and currentUser to context, so they can be used in PageComponent.getInitialProps\n              ctx.token = token;\n              ctx.currentUser = currentUser;\n              pageProps = {};\n\n              if (!PageComponent.getInitialProps) {\n                _context.next = 25;\n                break;\n              }\n\n              _context.next = 24;\n              return PageComponent.getInitialProps(ctx);\n\n            case 24:\n              pageProps = _context.sent;\n\n            case 25:\n              _pageProps = pageProps, authRequired = _pageProps.authRequired;\n\n              if (authRequired && !currentUser) {\n                if (false) ctx.res.redirect('/signIn');else Router.push('/signIn');\n              }\n\n              return _context.abrupt(\"return\", _objectSpread({\n                currentUser: currentUser\n              }, pageProps));\n\n            case 28:\n            case \"end\":\n              return _context.stop();\n          }\n        }\n      }, _callee, null, [[4, 10]]);\n    }));\n\n    return function (_x) {\n      return _ref2.apply(this, arguments);\n    };\n  }();\n\n  return WithAuth;\n}","map":null,"metadata":{},"sourceType":"module"}